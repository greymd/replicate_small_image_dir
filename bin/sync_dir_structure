#!/usr/bin/env bash

## Sync directories between source dir and destination dir.
## Create simlinks, which goes to source from destination, for each destination dir.

set -u
readonly ORIG_LINK="0_original"
readonly SDS_DEBUG=${SDS_DEBUG:-0}
TMPDIR=${TMPDIR:-${XDG_RUNTIME_DIR:-/tmp}}
trap 'rm -f "$TMPDIR"/src_list "$TMPDIR"/dst_list' EXIT

log_info () {
  printf "$(date "+%F_%T ")"'[INFO] %s\n' "$1" >&2
}

main () {
  local _src="${1%/}" ;shift
  local _dst="${1%/}" ;shift
  local _exec=
  if [[ $SDS_DEBUG == 1 ]];then
    _exec="cat"
  else
    _exec="sh"
  fi
  [[ -d "$_dst" ]] || {
    log_info "Create dir $_dst"
    mkdir "$_dst"
  }
  find "$_src" -type d |
    sed "s:^$_src::"  |
    sort > "$TMPDIR/src_list"
  find "$_dst" -type d |
    sed "s:^$_dst::"  |
    sort > "$TMPDIR/dst_list"
  ## Delete dir
  while read -r d;
  do
    local _dstdir="$_dst$d"
    log_info "Delete $d"
    echo "rm -rf ${_dstdir@Q}" | $_exec
  done < <(comm -13 "$TMPDIR/src_list" "$TMPDIR/dst_list")
  ## Create dir
  while read -r d;
  do
    local _dstdir="$_dst$d"
    local _srcdir="$_src$d"
    _srcdir=$(realpath "$_srcdir")
    [[ -d "${_dstdir}" ]] || {
      log_info "Create dir $_dstdir"
      echo "mkdir -p ${_dstdir@Q}" | $_exec
    }
    [[ -e "$_dstdir/$ORIG_LINK" ]] || {
      log_info "Create simlink $_dstdir/$ORIG_LINK"
      echo "ln -s ${_srcdir@Q} ${_dstdir@Q}/$ORIG_LINK" | $_exec
    }
  done < <(comm -23 "$TMPDIR/src_list" "$TMPDIR/dst_list")
  cat "$TMPDIR"/src_list
}

main ${1+"$@"}
